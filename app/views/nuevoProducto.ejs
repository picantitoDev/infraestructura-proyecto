<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <title>Registrar Producto</title>
    <link rel="stylesheet" href="/crearProducto.css" />
    <style>
      .error-msg {
        color: red;
        font-size: 0.9em;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <section class="form-section">
        <a href="/productos" class="back-btn">
          <span class="back-arrow">←</span> Atrás
        </a>
        <h2 style="text-align: center">Registrar Nuevo Producto</h2>
        <form
          id="producto-form"
          action="/productos/crear-producto"
          method="POST"
        >
          <div>
            <label for="nombre">Nombre del Producto:</label>
            <input type="text" id="nombre" name="nombre" required />
            <div id="nombre-error" class="error-msg"></div>
          </div>
          <div>
            <label for="cantidad_minima">Cantidad Mínima:</label>
            <input
              type="number"
              step="1"
              id="cantidad_minima"
              name="cantidad_minima"
              min="1"
              required
            />
          </div>
          <div>
            <label for="stock">Stock:</label>
            <input type="number" id="stock" name="stock" min="0" required />
          </div>
          <div>
            <label for="precio_unitario">Precio Unitario:</label>
            <input
              type="number"
              step="0.1"
              id="precio_unitario"
              name="precio_unitario"
              min="0.1"
              required
            />
          </div>
          <div>
            <label for="categoria">Categoría:</label>
            <select id="categoria" name="id_categoria" required>
              <% categorias.forEach((categoria) => { %>
              <option value="<%= categoria.id_categoria %>">
                <%= categoria.nombre %>
              </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="proveedor">Proveedor:</label>
            <select id="proveedor" name="id_proveedor" required>
              <% proveedores.forEach((proveedor) => { %>
              <option value="<%= proveedor.id_proveedor %>">
                <%= proveedor.razon_social %>
              </option>
              <% }) %>
            </select>
          </div>
          <button type="submit" id="submit-btn">Registrar Producto</button>
        </form>
      </section>
    </div>

    <!-- Productos en JSON -->
    <script id="productos-data" type="application/json">
      <%- JSON.stringify(productos) %>
    </script>

    <!-- Validación en vivo -->
    <script>
      const productos = JSON.parse(
        document.getElementById("productos-data").textContent
      )
      const form = document.getElementById("producto-form")
      const nombreInput = document.getElementById("nombre")
      const nombreError = document.getElementById("nombre-error")
      const submitBtn = document.getElementById("submit-btn")

      function verificarNombre(nombre) {
        const nombreNormalizado = nombre.trim().toLowerCase()
        return productos.some(
          (p) => p.nombre.toLowerCase() === nombreNormalizado
        )
      }
      
     const regexNombreValido = /^(?=.*\p{L})[\p{L}\d ,.'-]+$/u;

      
    function validarNombre() {
        const nombre = nombreInput.value.trim();

        // Si el campo está vacío, limpiar error y desactivar botón
        if (nombre === "") {
          nombreError.textContent = "";
          submitBtn.disabled = true;
          submitBtn.style.opacity = 0.5;
          return;
        }

        // Validar formato
        if (!regexNombreValido.test(nombre)) {
          nombreError.textContent = "Debe contener al menos una letra. Solo se permiten letras, comas, puntos, apóstrofes y espacios.";
          submitBtn.disabled = true;
          submitBtn.style.opacity = 0.5;
          return;
        }

        // Validar si ya existe
        if (verificarNombre(nombre)) {
          nombreError.textContent = "Este producto ya existe.";
          submitBtn.disabled = true;
          submitBtn.style.opacity = 0.5;
          return;
        }

        // Todo válido
        nombreError.textContent = "";
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
      }

      nombreInput.addEventListener("input", validarNombre)

      // Inicializar estado del botón si hay un valor ya precargado
      window.addEventListener("DOMContentLoaded", validarNombre)
    </script>
  </body>
</html>
