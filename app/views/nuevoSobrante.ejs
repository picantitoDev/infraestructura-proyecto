<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <title>Registrar Sobrante</title>
    <link rel="stylesheet" href="/registrarSobrante.css" />
    <style>
      /* Estilo básico */
      #autocomplete-results {
        max-height: 150px;
        overflow-y: auto;
        position: absolute;
        width: 550px;
        background-color: white;
        border: none; /* No borde al inicio */
        z-index: 1000;
      }
      .autocomplete-item {
        padding: 10px;
        cursor: pointer;
      }
      .autocomplete-item:hover {
        background-color: #f0f0f0;
      }

      .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        background-color: #6c757d;
      }
      /* Spinner animation */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/movimientos">← Atrás</a>
      <h1 class="title">Registrar Sobrante</h1>

      <form id="adjustmentForm" action="/movimientos/registrar-sobrante" method="POST">
        <div class="form-group" style="position: relative">
          <label for="producto">Producto</label>
          <input
            type="text"
            id="producto"
            name="producto"
            placeholder="Buscar producto..."
            autocomplete="off"
            required
          />
          <div id="autocomplete-results"></div>
        </div>

        <div class="form-group">
          <label for="cantidad">Cantidad</label>
          <input
            type="number"
            id="cantidad"
            name="cantidad"
            placeholder="Cantidad"
            required
            min="1"
          />
        </div>

        <div class="form-group">
          <label for="motivo">Motivo</label>
          <select id="motivo" name="motivo" required>
            <option value="error_conteo_fisico">Error en el conteo físico</option>
            <option value="recepcion_no_registrada">Recepción no registrada</option>
            <option value="error_registro_anterior">Error en registro anterior</option>
            <option value="otros">Otros (especificar)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="descripcion">Descripción</label>
          <textarea
            id="descripcion"
            name="descripcion"
            placeholder="Detalles adicionales..."
            required
          ></textarea>
        </div>

        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            Registrar Ajuste
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="window.location.href='/movimientos'"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>

    <!-- Productos disponibles en JSON -->
    <script id="productos-data" type="application/json">
      <%- JSON.stringify(productos) %>
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const productos = JSON.parse(
          document.getElementById("productos-data").textContent
        )
        const productoInput = document.getElementById("producto")
        const resultsContainer = document.getElementById("autocomplete-results")

        productoInput.addEventListener("input", function () {
          const query = productoInput.value.trim().toLowerCase()
          resultsContainer.innerHTML = ""
          resultsContainer.style.border = "none"

          if (query.length < 2) return

          const productosFiltrados = productos.filter((producto) =>
            producto.nombre.toLowerCase().includes(query)
          )

          if (productosFiltrados.length > 0) {
            productosFiltrados.forEach((producto) => {
              const resultItem = document.createElement("div")
              resultItem.classList.add("autocomplete-item")
              resultItem.setAttribute("data-nombre", producto.nombre)
              resultItem.textContent = `${producto.nombre} - Stock: ${producto.stock} - $${producto.precio_unitario}`

              resultItem.addEventListener("click", function () {
                productoInput.value = resultItem.getAttribute("data-nombre")
                resultsContainer.innerHTML = ""
                resultsContainer.style.border = "none"
              })

              resultsContainer.appendChild(resultItem)
            })
            resultsContainer.style.border = "1px solid gray"
          } else {
            const noResult = document.createElement("div")
            noResult.textContent = "No se encontraron productos"
            noResult.classList.add("autocomplete-item")
            resultsContainer.appendChild(noResult)
            resultsContainer.style.border = "1px solid gray"
          }
        })

        const form = document.getElementById("adjustmentForm")
        const submitBtn = document.getElementById("submitBtn")

        form.addEventListener("submit", function (e) {
          const normalizar = (str) =>
            str
              .normalize("NFD") // Elimina tildes
              .replace(/[\u0300-\u036f]/g, "")
              .trim()
              .toLowerCase()

          const productoNombre = normalizar(productoInput.value)
          const productoValido = productos.find(
            (p) => normalizar(p.nombre) === productoNombre
            )

          if (!productoValido) {
            e.preventDefault()
            alert("El producto ingresado no es válido o no está disponible.")
            submitBtn.disabled = false
            submitBtn.innerHTML = "Registrar Ajuste"
            return
          }

          submitBtn.disabled = true
          submitBtn.innerHTML = '<span class="spinner"></span> Procesando...'
        })
      })

      productoInput.addEventListener("input", function () {
  const productoNombre = normalizar(productoInput.value)
  const productoValido = productos.some(p => normalizar(p.nombre) === productoNombre)
  submitBtn.disabled = !productoValido
})

    </script>
  </body>
</html>
